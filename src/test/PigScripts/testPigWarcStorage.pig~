/* 
      
*/       

-- STORE command for the word count:
%declare WORD_COUNT_STORE_COMMAND "STORE sorted INTO '$WORD_COUNT_DEST' USING PigStorage(',');";

REGISTER $USER_CONTRIB/piggybank.jar;
REGISTER $PIGIR_HOME/target/pigir.jar;

docs = LOAD '$WARC_FILE'
		USING edu.stanford.pigir.warc.WarcLoader
       AS (warcRecordId:chararray, contentLength:int, date:chararray, warc_type:chararray,
           optionalHeaderFlds:bytearray, content:chararray);

strippedDocs = FOREACH docs GENERATE edu.stanford.pigir.pigudf.StripHTML(content);

/* Tokenize, using default regexp for splitting (the null), eliminiating
   stopwords (first '1' in parameter list), and preserving URLs 
   (second '1' in parms):
*/   
strippedWords = FOREACH strippedDocs GENERATE FLATTEN(edu.stanford.pigir.pigudf.RegexpTokenize(content, null, 1, 1));

strippedGroupedWords = GROUP strippedWords BY $0;

wordCounts = FOREACH strippedGroupedWords GENERATE $0 AS word:chararray ,COUNT($1) AS count:long;
sorted     = ORDER wordCounts BY word PARALLEL 5;

$WORD_COUNT_STORE_COMMAND;

